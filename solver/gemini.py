import google.generativeai as genai
from django.conf import settings
import base64

genai.configure(api_key=settings.GEMINI_API_KEY)
model = genai.GenerativeModel("gemini-2.5-flash")

# ===================== EXPLAIN SOLUTION =====================
def solve_math_explain(problem):
    prompt = f"""
    ‡∂î‡∂∂ ‡∂Ö‡∂≠‡∑ä‡∂Ø‡∑ê‡∂ö‡∑ì‡∂∏‡∑ä ‡∂á‡∂≠‡∑í ‡∂ú‡∂´‡∑í‡∂≠ ‡∂ú‡∑î‡∂ª‡∑î‡∑Ä‡∂ª‡∂∫‡∑ô‡∂ö‡∑ä.

    ‡∂¥‡∑Ñ‡∂≠ ‡∂ú‡∂´‡∑í‡∂≠ ‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä
    üëâ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂∫‡∑ô‡∂±‡∑ä‡∂∏ ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∑ô‡∂±‡∑ä
    üëâ ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª‡∑ô‡∂±‡∑ä ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª
    üëâ ‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂±‡∑í‡∂ö ‡∑Ñ‡∑è ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í ‡∂Ω‡∑ô‡∑É

    ‡∑Ä‡∑í‡∑É‡∂≥‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±.

    ‡∂Ö‡∑Ä‡∑É‡∑è‡∂±‡∂∫‡∑ö:
    "‡∂Ö‡∑Ä‡∑É‡∑è‡∂± ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª:" ‡∂Ω‡∑ô‡∑É ‡∑É‡∂Ø‡∑Ñ‡∂±‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.

    ‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä:
    {problem}
    """
    return model.generate_content(prompt).text


# ===================== DIRECT ANSWER =====================
def solve_math_direct(problem):
    prompt = f"""
    ‡∂¥‡∑Ñ‡∂≠ ‡∂ú‡∂´‡∑í‡∂≠ ‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä
    üëâ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂∫‡∑ô‡∂±‡∑ä‡∂∏ ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∑ô‡∂±‡∑ä
    üëâ ‡∂â‡∂≠‡∑è ‡∂ö‡∑ô‡∂ß‡∑í ‡∂Ω‡∑ô‡∑É
    üëâ ‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª ‡∂±‡∑ú‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è

    "‡∂Ö‡∑Ä‡∑É‡∑è‡∂± ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª:" ‡∂Ω‡∑ô‡∑É ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±.

    ‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä:
    {problem}
    """
    return model.generate_content(prompt).text


# ===================== HANDWRITTEN IMAGE ‚Üí TEXT =====================
def extract_math_from_image(image_base64):
    # Remove data URL header if exists
    if "," in image_base64:
        image_base64 = image_base64.split(",")[1]

    image_bytes = base64.b64decode(image_base64)

    prompt = """
    ‡∂î‡∂∂ ‡∂ú‡∂´‡∑í‡∂≠ ‡∂ú‡∑î‡∂ª‡∑î‡∑Ä‡∂ª‡∂∫‡∑ô‡∂ö‡∑ä ‡∂Ω‡∑ô‡∑É ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.

    ‡∂∏‡∑ô‡∂∏ ‡∂¥‡∑í‡∂±‡∑ä‡∂≠‡∑ñ‡∂ª‡∂∫‡∑ö ‡∂Ö‡∂≠‡∑ä‡∂Ω‡∑í‡∂∫‡∂± ‡∑Ñ‡∑ù ‡∂∏‡∑î‡∂Ø‡∑ä‚Äç‡∂ª‡∑í‡∂≠
    ‡∂ú‡∂´‡∑í‡∂≠ ‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∂±‡∑ä‡∂±.

    ‡∂ö‡∂ª‡∑î‡∂´‡∑î:
    - ‡∂Ö‡∂≠‡∑ä‡∂Ω‡∑í‡∂∫‡∂± ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∑É‡∑Ñ ‡∑É‡∂Ç‡∂ö‡∑ö‡∂≠ ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∑Ä ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∂±‡∑ä‡∂±
    - √ó ‚Üí *, √∑ ‚Üí /, ¬≤ ‚Üí ^2, ‚àö ‚Üí sqrt ‡∂Ω‡∑ô‡∑É ‡∑É‡∂∏‡∑ä‡∂∏‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    - ‡∂ö‡∑í‡∑É‡∑í‡∂Ø‡∑î ‡∑Ä‡∑í‡∑É‡∂≥‡∑î‡∂∏‡∂ö‡∑ä ‡∂Ø‡∑ô‡∂±‡∑ä‡∂± ‡∂ë‡∂¥‡∑è
    - ‡∂ö‡∑í‡∑É‡∑í‡∂Ø‡∑î ‡∂Ö‡∂≠‡∑í‡∂ª‡∑ö‡∂ö ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫‡∂ö‡∑ä ‡∂Ø‡∑ô‡∂±‡∑ä‡∂± ‡∂ë‡∂¥‡∑è

    OUTPUT:
    üëâ ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∂ú‡∂´‡∑í‡∂≠ ‡∂ú‡∑ê‡∂ß‡∑Ö‡∑î‡∑Ä text ‡∂Ω‡∑ô‡∑É
    üëâ ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä‡∑ô‡∂±‡∑ä
    """

    response = model.generate_content([
        prompt,
        image_bytes
    ])

    return response.text.strip()


